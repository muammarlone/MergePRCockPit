#!/usr/bin/env node

/**
 * Generate run manifest and index for UAT test executions
 * Creates a comprehensive index of all test runs with metadata
 */

const fs = require('fs-extra');
const path = require('path');

async function generateRunManifest() {
  console.log('Generating UAT run manifest and index...');

  const reportsDir = path.join(__dirname, '..', 'reports');
  const evidenceDir = path.join(__dirname, '..', 'evidence');
  const manifestPath = path.join(reportsDir, 'run-manifest.json');
  const indexPath = path.join(reportsDir, 'test-index.md');

  try {
    await fs.ensureDir(reportsDir);

    // Collect information about all test runs
    const testDirs = [];
    if (await fs.pathExists(evidenceDir)) {
      const entries = await fs.readdir(evidenceDir);
      for (const entry of entries) {
        const entryPath = path.join(evidenceDir, entry);
        const stat = await fs.stat(entryPath);
        if (stat.isDirectory() && entry.startsWith('UAT-')) {
          testDirs.push(entry);
        }
      }
    }

    // Generate manifest with test metadata
    const manifest = {
      generatedAt: new Date().toISOString(),
      totalTests: testDirs.length,
      tests: [],
    };

    for (const testDir of testDirs) {
      const evidencePath = path.join(evidenceDir, testDir);
      const reportPath = path.join(evidencePath, 'evidence-report.json');
      
      let testInfo = {
        testId: testDir,
        hasEvidence: true,
        evidencePath: path.relative(reportsDir, evidencePath),
      };

      if (await fs.pathExists(reportPath)) {
        try {
          const report = await fs.readJson(reportPath);
          testInfo = {
            ...testInfo,
            timestamp: report.timestamp,
            evidenceItems: report.evidence?.length || 0,
            sanitized: report.sanitizationApplied || false,
          };
        } catch (error) {
          console.warn(`Could not read report for ${testDir}:`, error.message);
        }
      }

      manifest.tests.push(testInfo);
    }

    // Sort tests by testId
    manifest.tests.sort((a, b) => a.testId.localeCompare(b.testId));

    // Write manifest
    await fs.writeJson(manifestPath, manifest, { spaces: 2 });
    console.log(`✓ Manifest written to: ${manifestPath}`);

    // Generate markdown index
    const index = `# UAT Test Index

**Generated:** ${new Date().toLocaleString()}  
**Total Tests:** ${manifest.totalTests}

## Test Cases

| Test ID | Evidence Items | Sanitized | Last Run |
|---------|----------------|-----------|----------|
${manifest.tests.map(test => 
  `| ${test.testId} | ${test.evidenceItems || 'N/A'} | ${test.sanitized ? '✅' : '❌'} | ${test.timestamp ? new Date(test.timestamp).toLocaleString() : 'N/A'} |`
).join('\n')}

## Test Categories

### Architecture Tests
${manifest.tests.filter(t => t.testId.startsWith('UAT-ARCH')).map(t => `- ${t.testId}`).join('\n') || '- None'}

### Authentication Tests
${manifest.tests.filter(t => t.testId.startsWith('UAT-AUTH')).map(t => `- ${t.testId}`).join('\n') || '- None'}

### Analytics Tests
${manifest.tests.filter(t => t.testId.startsWith('UAT-ANALYTICS')).map(t => `- ${t.testId}`).join('\n') || '- None'}

### Application Tests
${manifest.tests.filter(t => t.testId.startsWith('UAT-APP')).map(t => `- ${t.testId}`).join('\n') || '- None'}

## Evidence Locations

${manifest.tests.map(test => 
  `- **${test.testId}**: \`${test.evidencePath}\``
).join('\n')}

---

*Generated by MergePRCockPit UAT Testing Framework*
`;

    await fs.writeFile(indexPath, index);
    console.log(`✓ Index written to: ${indexPath}`);

    console.log('\n✅ Run manifest and index generation complete!');
    console.log(`   Manifest: ${manifestPath}`);
    console.log(`   Index: ${indexPath}`);
    console.log(`   Tests cataloged: ${manifest.totalTests}`);

  } catch (error) {
    console.error('Error generating run manifest:', error);
    process.exit(1);
  }
}

generateRunManifest();
